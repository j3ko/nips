name: Generate Dependency Graph

on:
  pull_request:

jobs:
  generate_dependency_graph:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Generate dependency graph
        run: |
          # Get list of modified Markdown files in PR
          files=( ./*.md )

          # Concatenate dependencies for all Markdown files
          dependencies=""
          for file in "${files[@]}"; do
            # Get the list of dependencies
            deps=$(grep -o 'depends:[0-9]\+' $file | sort | uniq | sed "s/depends://" | awk -v f="${file/.\//NIP-}" '{sub(/\.md/, "", f); print "\"" f "\" -> \"NIP-" $1 "\""}')
            # Append the dependencies to the variable
            dependencies="$dependencies $deps"
          done

          # Output the dependency graph in the dot format
          echo "digraph nips { $dependencies }" | dot -Tpng -o dependencies.png

          # Get the pull request number
          pr_number=$(echo $GITHUB_REF | sed 's|.*/||')

          # Set the Git config variables
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

          # Checkout the branch associated with the pull request
          git fetch origin pull/$pr_number/head:pr-$pr_number
          git checkout pr-$pr_number

          # Copy the dependency graph to the root of the repository
          cp dependencies.png ../

          # Add the new file to the index
          git add ../dependencies.png

          # Create a new commit and push it to the pull request branch
          git commit -m "Update dependency graph" -a
          git push origin HEAD

      - name: Delete local changes
        run: |
          rm -f dependencies.png
          git reset --hard HEAD^
          git clean -f -d
